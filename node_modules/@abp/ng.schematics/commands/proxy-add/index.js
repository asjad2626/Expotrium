"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const utils_1 = require("../../utils");
function default_1(schema) {
    const params = (0, utils_1.removeDefaultPlaceholders)(schema);
    const moduleName = params.module || 'app';
    return (0, schematics_1.chain)([
        async (host) => {
            const target = await (0, utils_1.resolveProject)(host, params.target);
            const targetPath = (0, utils_1.buildTargetPath)(target.definition, params.entryPoint);
            const readProxyConfig = (0, utils_1.createProxyConfigReader)(targetPath);
            let generated = [];
            try {
                generated = readProxyConfig(host).generated;
                const index = generated.findIndex(m => m === moduleName);
                if (index < 0)
                    generated.push(moduleName);
            }
            catch (_) {
                generated.push(moduleName);
            }
            const getApiDefinition = (0, utils_1.createApiDefinitionGetter)(params);
            const data = { generated, ...(await getApiDefinition(host)) };
            data.generated = [];
            const clearProxy = (0, utils_1.createProxyClearer)(targetPath);
            const saveProxyConfig = (0, utils_1.createProxyConfigSaver)(data, targetPath);
            const saveProxyWarning = (0, utils_1.createProxyWarningSaver)(targetPath);
            const generateApis = (0, utils_1.createApisGenerator)(schema, generated);
            const generateIndex = (0, utils_1.createProxyIndexGenerator)(targetPath);
            return (0, schematics_1.chain)([
                (0, utils_1.mergeAndAllowDelete)(host, clearProxy),
                saveProxyConfig,
                saveProxyWarning,
                generateApis,
                generateIndex,
            ]);
        },
    ]);
}
exports.default = default_1;
//# sourceMappingURL=index.js.map