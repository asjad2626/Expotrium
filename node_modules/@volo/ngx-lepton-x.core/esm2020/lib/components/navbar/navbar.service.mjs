import { Inject, Injectable } from '@angular/core';
import { DataStore } from '../../utils/data-store';
import { LPX_MENU_ITEMS } from './navbar.token';
import { ActivatedRoute, NavigationEnd, Router } from '@angular/router';
import { filter, take, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
export class NavbarService {
    constructor(menuItems, route, router) {
        this.menuItems = menuItems;
        this.route = route;
        this.router = router;
        this.store = new DataStore(this.addContainerLinks(this.menuItems));
        this.navbarItems$ = this.store.sliceState((state) => state);
        this.expandItemByLink$().pipe(take(1)).subscribe();
    }
    addNavbarItems(...menuItems) {
        this.store.set([...this.store.state, ...this.addContainerLinks(menuItems)]);
    }
    setNavbarItems(...menuItems) {
        this.store.set([...this.addContainerLinks(menuItems)]);
    }
    // TODO: muhammed: refactor this method to be readable
    addChildren(id, ...menuItems) {
        const parent = this.findById(id, this.store.state);
        const update = (items, location, link = '') => {
            const i = location.shift();
            return items.reduce((acc, item, index) => {
                return [
                    ...acc,
                    ...(index === i
                        ? [
                            {
                                ...item,
                                children: !location.length
                                    ? [
                                        ...(item.children || []),
                                        ...this.addContainerLinks(menuItems, `${link}/${item.containerLink}`),
                                    ]
                                    : update(item.children || [], location, `${link}/${item.containerLink}`),
                            },
                        ]
                        : [item]),
                ];
            }, []);
        };
        const updated = update(this.store.state, parent.location);
        this.store.patch(updated);
    }
    findByLink(link, items) {
        return this.findByProp('link', link, items);
    }
    expandItemByLink$() {
        return this.router.events
            .pipe(filter((e) => e instanceof NavigationEnd), tap(() => this.calculateExpandState()));
    }
    calculateExpandState() {
        const route = this.findByLink(this.router.url);
        const expand = (items, indexes) => {
            const matchIndex = indexes.shift();
            return items.reduce((acc, item, index) => {
                if (index === matchIndex) {
                    return [
                        ...acc,
                        {
                            ...item,
                            expanded: true,
                            selected: true,
                            children: expand(item.children || [], indexes),
                        },
                    ];
                }
                return [...acc, { ...item, expanded: false, selected: false }];
            }, []);
        };
        if (route?.item) {
            const expanded = expand(this.store.state, route.location);
            this.store.patch(expanded);
        }
    }
    findById(id, items) {
        return this.findByProp('id', id, items);
    }
    findByProp(prop, value, items, location = []) {
        const navbarItems = items || this.store.state;
        const itemIndex = navbarItems.findIndex((i) => i[prop] === value);
        let item;
        if (itemIndex === -1) {
            navbarItems.forEach((i, index) => {
                if (i.children) {
                    const child = this.findByProp(prop, value, i.children, [
                        ...location,
                        index,
                    ]);
                    if (child?.item) {
                        item = child.item;
                        location = child.location;
                    }
                }
            });
        }
        else {
            item = navbarItems[itemIndex];
            location.push(itemIndex);
        }
        return { item, location };
    }
    addContainerLinks(items, link = '') {
        return items.map((item) => ({
            ...item,
            ...(item.link && link ? { link: `${link}/${item.link}` } : {}),
            children: this.addContainerLinks(item.children || [], `${link ? link + '/' : ''}${item.containerLink || ''}`),
        }));
    }
}
NavbarService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.0", ngImport: i0, type: NavbarService, deps: [{ token: LPX_MENU_ITEMS }, { token: i1.ActivatedRoute }, { token: i1.Router }], target: i0.ɵɵFactoryTarget.Injectable });
NavbarService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.0", ngImport: i0, type: NavbarService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.0", ngImport: i0, type: NavbarService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: undefined, decorators: [{
                    type: Inject,
                    args: [LPX_MENU_ITEMS]
                }] }, { type: i1.ActivatedRoute }, { type: i1.Router }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2YmFyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9saWJzL2xlcHRvbi14LWNvcmUvc3JjL2xpYi9jb21wb25lbnRzL25hdmJhci9uYXZiYXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxjQUFjLEVBQUUsYUFBYSxFQUFFLE1BQU0sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUFLbkQsTUFBTSxPQUFPLGFBQWE7SUFPeEIsWUFDa0MsU0FBMEIsRUFDbEQsS0FBcUIsRUFDckIsTUFBYztRQUZVLGNBQVMsR0FBVCxTQUFTLENBQWlCO1FBQ2xELFVBQUssR0FBTCxLQUFLLENBQWdCO1FBQ3JCLFdBQU0sR0FBTixNQUFNLENBQVE7UUFUaEIsVUFBSyxHQUFHLElBQUksU0FBUyxDQUMzQixJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUN2QyxDQUFDO1FBRUYsaUJBQVksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7UUFPckQsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQ3JELENBQUM7SUFFRCxjQUFjLENBQUMsR0FBRyxTQUEwQjtRQUMxQyxJQUFJLENBQUMsS0FBSyxD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QUMsRUFBRSxHQUFHLElBQUksQ0FBQyxhQUFhLElBQUksRUFBRSxFQUFFLENBQ3ZEO1NBQ0YsQ0FBQyxDQUFDLENBQUM7SUFDTixDQUFDOzswR0FwSlUsYUFBYSxrQkFRZCxjQUFjOzhHQVJiLGFBQWEsY0FGWixNQUFNOzJGQUVQLGFBQWE7a0JBSHpCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFTSSxNQUFNOzJCQUFDLGNBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3QsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgRGF0YVN0b3JlIH0gZnJvbSAnLi4vLi4vdXRpbHMvZGF0YS1zdG9yZSc7XHJcbmltcG9ydCB7IExweE5hdmJhckl0ZW0gfSBmcm9tICcuL21vZGVscyc7XHJcbmltcG9ydCB7IExQWF9NRU5VX0lURU1TIH0gZnJvbSAnLi9uYXZiYXIudG9rZW4nO1xyXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgTmF2aWdhdGlvbkVuZCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgZmlsdGVyLCB0YWtlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgTmF2YmFyU2VydmljZSB7XHJcbiAgcHJpdmF0ZSBzdG9yZSA9IG5ldyBEYXRhU3RvcmU8THB4TmF2YmFySXRlbVtdPihcclxuICAgIHRoaXMuYWRkQ29udGFpbmVyTGlua3ModGhpcy5tZW51SXRlbXMpXHJcbiAgKTtcclxuXHJcbiAgbmF2YmFySXRlbXMkID0gdGhpcy5zdG9yZS5zbGljZVN0YXRlKChzdGF0ZSkgPT4gc3RhdGUpO1xyXG5cclxuICBjb25zdHJ1Y3RvcihcclxuICAgIEBJbmplY3QoTFBYX01FTlVfSVRFTVMpIHByaXZhdGUgbWVudUl0ZW1zOiBMcHhOYXZiYXJJdGVtW10sXHJcbiAgICBwcml2YXRlIHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSxcclxuICAgIHByaXZhdGUgcm91dGVyOiBSb3V0ZXJcclxuICApIHtcclxuICAgIHRoaXMuZXhwYW5kSXRlbUJ5TGluayQoKS5waXBlKHRha2UoMSkpLnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgYWRkTmF2YmFySXRlbXMoLi4ubWVudUl0ZW1zOiBMcHhOYXZiYXJJdGVtW10pOiB2b2lkIHtcclxuICAgIHRoaXMuc3RvcmUuc2V0KFsuLi50aGlzLnN0b3JlLnN0YXRlLCAuLi50aGlzLmFkZENvbnRhaW5lckxpbmtzKG1lbnVJdGVtcyldKTtcclxuICB9XHJcblxyXG4gIHNldE5hdmJhckl0ZW1zKC4uLm1lbnVJdGVtczogTHB4TmF2YmFySXRlbVtdKTogdm9pZCB7XHJcbiAgICB0aGlzLnN0b3JlLnNldChbLi4udGhpcy5hZGRDb250YWluZXJMaW5rcyhtZW51SXRlbXMpXSk7XHJcbiAgfVxyXG5cclxuICAvLyBUT0RPOiBtdWhhbW1lZDogcmVmYWN0b3IgdGhpcyBtZXRob2QgdG8gYmUgcmVhZGFibGVcclxuICBhZGRDaGlsZHJlbihpZDogc3RyaW5nLCAuLi5tZW51SXRlbXM6IExweE5hdmJhckl0ZW1bXSk6IHZvaWQge1xyXG4gICAgY29uc3QgcGFyZW50ID0gdGhpcy5maW5kQnlJZChpZCwgdGhpcy5zdG9yZS5zdGF0ZSk7XHJcbiAgICBjb25zdCB1cGRhdGUgPSAoXHJcbiAgICAgIGl0ZW1zOiBMcHhOYXZiYXJJdGVtW10sXHJcbiAgICAgIGxvY2F0aW9uOiBBcnJheTxudW1iZXI+LFxyXG4gICAgICBsaW5rID0gJydcclxuICAgICk6IExweE5hdmJhckl0ZW1bXSA9PiB7XHJcbiAgICAgIGNvbnN0IGkgPSBsb2NhdGlvbi5zaGlmdCgpO1xyXG4gICAgICByZXR1cm4gaXRlbXMucmVkdWNlKChhY2MsIGl0ZW0sIGluZGV4KSA9PiB7XHJcbiAgICAgICAgcmV0dXJuIFtcclxuICAgICAgICAgIC4uLmFjYyxcclxuICAgICAgICAgIC4uLihpbmRleCA9PT0gaVxyXG4gICAgICAgICAgICA/IFtcclxuICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgLi4uaXRlbSxcclxuICAgICAgICAgICAgICAgICAgY2hpbGRyZW46ICFsb2NhdGlvbi5sZW5ndGhcclxuICAgICAgICAgICAgICAgICAgICA/IFtcclxuICAgICAgICAgICAgICAgICAgICAgICAgLi4uKGl0ZW0uY2hpbGRyZW4gfHwgW10pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuLi50aGlzLmFkZENvbnRhaW5lckxpbmtzKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG1lbnVJdGVtcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICBgJHtsaW5rfS8ke2l0ZW0uY29udGFpbmVyTGlua31gXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICAgICAgOiB1cGRhdGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW0uY2hpbGRyZW4gfHwgW10sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2F0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBgJHtsaW5rfS8ke2l0ZW0uY29udGFpbmVyTGlua31gXHJcbiAgICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgIDogW2l0ZW1dKSxcclxuICAgICAgICBdO1xyXG4gICAgICB9LCBbXSBhcyBMcHhOYXZiYXJJdGVtW10pO1xyXG4gICAgfTtcclxuICAgIGNvbnN0IHVwZGF0ZWQgPSB1cGRhdGUodGhpcy5zdG9yZS5zdGF0ZSwgcGFyZW50LmxvY2F0aW9uKTtcclxuICAgIHRoaXMuc3RvcmUucGF0Y2godXBkYXRlZCk7XHJcbiAgfVxyXG5cclxuICBmaW5kQnlMaW5rKGxpbms6IHN0cmluZywgaXRlbXM/OiBMcHhOYXZiYXJJdGVtW10pIHtcclxuICAgIHJldHVybiB0aGlzLmZpbmRCeVByb3AoJ2xpbmsnLCBsaW5rLCBpdGVtcyk7XHJcbiAgfVxyXG5cclxuICBleHBhbmRJdGVtQnlMaW5rJCgpIHtcclxuICAgIHJldHVybiB0aGlzLnJvdXRlci5ldmVudHNcclxuICAgICAgLnBpcGUoXHJcbiAgICAgICAgZmlsdGVyKChlKSA9PiBlIGluc3RhbmNlb2YgTmF2aWdhdGlvbkVuZCksXHJcbiAgICAgICAgdGFwKCgpPT4gdGhpcy5jYWxjdWxhdGVFeHBhbmRTdGF0ZSgpKVxyXG4gICAgICApXHJcbiAgfVxyXG5cclxuICBjYWxjdWxhdGVFeHBhbmRTdGF0ZSgpIHtcclxuICAgIGNvbnN0IHJvdXRlID0gdGhpcy5maW5kQnlMaW5rKHRoaXMucm91dGVyLnVybCk7XHJcbiAgICBjb25zdCBleHBhbmQgPSAoXHJcbiAgICAgIGl0ZW1zOiBMcHhOYXZiYXJJdGVtW10sXHJcbiAgICAgIGluZGV4ZXM6IEFycmF5PG51bWJlcj5cclxuICAgICk6IExweE5hdmJhckl0ZW1bXSA9PiB7XHJcbiAgICAgIGNvbnN0IG1hdGNoSW5kZXggPSBpbmRleGVzLnNoaWZ0KCk7XHJcbiAgICAgIHJldHVybiBpdGVtcy5yZWR1Y2UoKGFjYywgaXRlbSwgaW5kZXgpID0+IHtcclxuICAgICAgICBpZiAoaW5kZXggPT09IG1hdGNoSW5kZXgpIHtcclxuICAgICAgICAgIHJldHVybiBbXHJcbiAgICAgICAgICAgIC4uLmFjYyxcclxuICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgIC4uLml0ZW0sXHJcbiAgICAgICAgICAgICAgZXhwYW5kZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXHJcbiAgICAgICAgICAgICAgY2hpbGRyZW46IGV4cGFuZChpdGVtLmNoaWxkcmVuIHx8IFtdLCBpbmRleGVzKSxcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgIF07XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBbLi4uYWNjLCB7Li4uaXRlbSwgZXhwYW5kZWQ6IGZhbHNlLCBzZWxlY3RlZDogZmFsc2V9XTtcclxuICAgICAgfSwgW10gYXMgTHB4TmF2YmFySXRlbVtdKTtcclxuICAgIH07XHJcbiAgICBpZiAocm91dGU/Lml0ZW0pIHtcclxuICAgICAgY29uc3QgZXhwYW5kZWQgPSBleHBhbmQodGhpcy5zdG9yZS5zdGF0ZSwgcm91dGUubG9jYXRpb24pO1xyXG4gICAgICB0aGlzLnN0b3JlLnBhdGNoKGV4cGFuZGVkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmluZEJ5SWQoaWQ6IHN0cmluZywgaXRlbXM/OiBMcHhOYXZiYXJJdGVtW10pIHtcclxuICAgIHJldHVybiB0aGlzLmZpbmRCeVByb3AoJ2lkJywgaWQsIGl0ZW1zKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZmluZEJ5UHJvcChcclxuICAgIHByb3A6IGtleW9mIExweE5hdmJhckl0ZW0sXHJcbiAgICB2YWx1ZTogc3RyaW5nLFxyXG4gICAgaXRlbXM/OiBMcHhOYXZiYXJJdGVtW10sXHJcbiAgICBsb2NhdGlvbjogQXJyYXk8bnVtYmVyPiA9IFtdXHJcbiAgKSB7XHJcbiAgICBjb25zdCBuYXZiYXJJdGVtcyA9IGl0ZW1zIHx8IHRoaXMuc3RvcmUuc3RhdGU7XHJcbiAgICBjb25zdCBpdGVtSW5kZXggPSBuYXZiYXJJdGVtcy5maW5kSW5kZXgoKGkpID0+IGlbcHJvcF0gPT09IHZhbHVlKTtcclxuICAgIGxldCBpdGVtO1xyXG4gICAgaWYgKGl0ZW1JbmRleCA9PT0gLTEpIHtcclxuICAgICAgbmF2YmFySXRlbXMuZm9yRWFjaCgoaSwgaW5kZXgpID0+IHtcclxuICAgICAgICBpZiAoaS5jaGlsZHJlbikge1xyXG4gICAgICAgICAgY29uc3QgY2hpbGQgPSB0aGlzLmZpbmRCeVByb3AocHJvcCwgdmFsdWUsIGkuY2hpbGRyZW4sIFtcclxuICAgICAgICAgICAgLi4ubG9jYXRpb24sXHJcbiAgICAgICAgICAgIGluZGV4LFxyXG4gICAgICAgICAgXSk7XHJcbiAgICAgICAgICBpZiAoY2hpbGQ/Lml0ZW0pIHtcclxuICAgICAgICAgICAgaXRlbSA9IGNoaWxkLml0ZW07XHJcbiAgICAgICAgICAgIGxvY2F0aW9uID0gY2hpbGQubG9jYXRpb247XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGl0ZW0gPSBuYXZiYXJJdGVtc1tpdGVtSW5kZXhdO1xyXG4gICAgICBsb2NhdGlvbi5wdXNoKGl0ZW1JbmRleCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHsgaXRlbSwgbG9jYXRpb24gfTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgYWRkQ29udGFpbmVyTGlua3MoXHJcbiAgICBpdGVtczogTHB4TmF2YmFySXRlbVtdLFxyXG4gICAgbGluayA9ICcnXHJcbiAgKTogTHB4TmF2YmFySXRlbVtdIHtcclxuICAgIHJldHVybiBpdGVtcy5tYXAoKGl0ZW0pID0+ICh7XHJcbiAgICAgIC4uLml0ZW0sXHJcbiAgICAgIC4uLihpdGVtLmxpbmsgJiYgbGluayA/IHsgbGluazogYCR7bGlua30vJHtpdGVtLmxpbmt9YCB9IDoge30pLFxyXG4gICAgICBjaGlsZHJlbjogdGhpcy5hZGRDb250YWluZXJMaW5rcyhcclxuICAgICAgICBpdGVtLmNoaWxkcmVuIHx8IFtdLFxyXG4gICAgICAgIGAke2xpbmsgPyBsaW5rICsgJy8nIDogJyd9JHtpdGVtLmNvbnRhaW5lckxpbmsgfHwgJyd9YFxyXG4gICAgICApLFxyXG4gICAgfSkpO1xyXG4gIH1cclxufVxyXG4iXX0=