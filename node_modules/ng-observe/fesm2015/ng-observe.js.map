{"version":3,"file":"ng-observe.js","sources":["../../../projects/ng-observe/src/lib/ng-observe.ts","../../../projects/ng-observe/src/ng-observe.ts"],"sourcesContent":["import {\n  ChangeDetectorRef,\n  Inject,\n  Injectable,\n  InjectionToken,\n  NgZone,\n  OnDestroy,\n  Optional,\n} from '@angular/core';\nimport { isObservable, Observable, Subscription } from 'rxjs';\n\nexport const HASH_FN = new InjectionToken<HashFn>('HASH_FN', {\n  providedIn: 'root',\n  factory: createHashFn,\n});\n\nconst BRAND = '__ngObserve__';\n\n// @dynamic\n@Injectable()\nexport class ObserveService implements OnDestroy {\n  private hooks = new Map<string | number, () => void>();\n  private detectChanges = () => this.cdRef.detectChanges();\n\n  collection: ObserveCollectionFn = (sources, options = {} as any) => {\n    const sink: any = Array.isArray(sources) ? [] : {};\n    Object.defineProperty(sink, BRAND, {\n      value: true,\n      enumerable: false,\n      writable: false,\n    });\n\n    const observe = this.observe(sink);\n    Object.keys(sources).forEach(key => {\n      const source: any = sources[key as keyof typeof sources];\n      const option: any = options[key as keyof typeof options];\n      observe(key, source, option);\n    });\n\n    return sink;\n  };\n\n  value: ObserveValueFn = <Value>(\n    source: Observable<Value>,\n    options?: ObserveValueOptions\n  ): Observed<Value> => {\n    const sink = {};\n\n    this.observe(sink)('value', source, options);\n\n    return toValue(sink, 'value');\n  };\n\n  constructor(\n    private cdRef: ChangeDetectorRef,\n    @Inject(HASH_FN) private hash: HashFn,\n    @Optional() zone: NgZone\n  ) {\n    if (zone instanceof NgZone) {\n      this.detectChanges = () => this.cdRef.markForCheck();\n    }\n  }\n\n  private createUniqueId(key: string | number | symbol): string {\n    try {\n      throw new Error();\n    } catch (e) {\n      return String(this.hash(e.stack + String(key)));\n    }\n  }\n\n  private observe(sink: any): Observe {\n    const fn = <Value>(\n      key: string | number | symbol,\n      source: Observable<Value>,\n      { uniqueId = this.createUniqueId(key), errorHandler = () => {} }: ObserveValueOptions = {}\n    ) => {\n      let subscription = new Subscription();\n      const noop = () => {};\n      const unsubscribe = () => subscription.unsubscribe();\n      const complete = () => {\n        (this.hooks.get(uniqueId) || noop)();\n        this.hooks.delete(uniqueId);\n      };\n\n      complete();\n      this.hooks.set(uniqueId, unsubscribe);\n\n      // tslint:disable-next-line: deprecation\n      subscription = source.subscribe({\n        next: x => {\n          sink[key] = x;\n          this.detectChanges();\n        },\n        error: errorHandler,\n        complete,\n      });\n    };\n\n    return fn;\n  }\n\n  ngOnDestroy(): void {\n    this.hooks.forEach(unsubscribe => unsubscribe());\n  }\n}\n\nexport const OBSERVE = new InjectionToken<ObserveFn>('OBSERVE');\n\nexport const OBSERVE_PROVIDER = [\n  ObserveService,\n  {\n    provide: OBSERVE,\n    useFactory: observeFactory,\n    deps: [ObserveService],\n  },\n];\n\nexport function observeFactory(service: ObserveService): ObserveFn {\n  return <ValueOrCollection extends any>(\n    source: Observable<ValueOrCollection> | ObservableCollection<ValueOrCollection>,\n    options?: ObserveValueOptions | ObserveCollectionOptions<ValueOrCollection>\n  ) =>\n    isObservable(source)\n      ? service.value(source, options as ObserveValueOptions)\n      : service.collection(source, options as ObserveCollectionOptions<ValueOrCollection>);\n}\n\ntype ObserveCollectionFn = <Collection>(\n  source: ObservableCollection<Collection>,\n  options?: ObserveCollectionOptions<Collection>\n) => Collection;\n\ntype ObserveValueFn = <Value>(\n  source: Observable<Value>,\n  options?: ObserveValueOptions\n) => Observed<Value>;\n\nexport type ObserveFn = <Source extends Observable<any> | ObservableCollection<any>>(\n  source: Source,\n  options?: ObserveFnOptions<Source>\n) => ObserveFnReturnValue<Source>;\n\ntype Observe = <Value>(\n  key: string | number | symbol,\n  source: Observable<Value>,\n  options?: ObserveValueOptions\n) => void;\n\nexport type ObservableCollection<Collection> = Collection extends Array<infer Value>\n  ? Array<Observable<Value>>\n  : { [Key in keyof Collection]: Observable<Collection[Key]> };\n\nexport type ObserveCollectionOptions<Collection> = Collection extends Array<any>\n  ? Array<ObserveValueOptions>\n  : { [Key in keyof Collection]?: ObserveValueOptions };\n\nexport type ObservedValues<Collection> = Collection extends Array<infer Value>\n  ? Array<Observed<Value>>\n  : { [Key in keyof Collection]: Observed<Collection[Key]> };\n\nexport interface ObserveValueOptions {\n  errorHandler?: (err: any) => void;\n  uniqueId?: string;\n}\n\nexport type ObserveFnOptions<Source> = Source extends Observable<any>\n  ? ObserveValueOptions\n  : Source extends ObservableCollection<infer Collection>\n  ? ObserveCollectionOptions<Collection>\n  : never;\n\nexport type ObserveFnReturnValue<Source> = Source extends Observable<infer Value>\n  ? Observed<Value>\n  : Source extends ObservableCollection<infer Collection>\n  ? Collection\n  : never;\n\nexport class Observed<Value, Seed = unknown> {\n  private readonly getter: () => Value;\n\n  constructor(private readonly seed: Seed, mapFn: (source: typeof seed) => Value) {\n    this.getter = () => mapFn(this.seed);\n  }\n\n  get value(): Value {\n    return this.getter();\n  }\n}\n\nexport type HashFn = (input: string) => number;\n\nexport function createHashFn(): HashFn {\n  const k = 2654435761;\n  const shift = Math.imul ? (n: number) => Math.imul(n, k) : (n: number) => imul(n, k);\n\n  const hashFn = (input: string) => {\n    let index = input.length;\n    let hash = 0xabadcafe;\n\n    while (index--) {\n      hash = shift(hash ^ input.charCodeAt(index));\n    }\n\n    return (hash ^ (hash >>> 16)) >>> 0;\n  };\n\n  return hashFn;\n}\n\n// https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math/imul\nexport function imul(a: number, b: number): number {\n  b |= 0;\n\n  let result = (a & 0x003fffff) * b;\n  if (a & 0xffc00000) {\n    result += ((a & 0xffc00000) * b) | 0;\n  }\n\n  return result | 0;\n}\n\nexport function isCollection(source: any): boolean {\n  return Boolean(source && source[BRAND]);\n}\n\nexport function toMappedValue<Value, Seed extends Array<any> | Record<string, any>>(\n  collection: Seed,\n  mapFn: (source: typeof collection) => Value\n): Observed<Value> {\n  return new Observed(collection as any, mapFn);\n}\n\nexport function toValue<Value>(collection: Array<Value>, key: number): Observed<Value>;\nexport function toValue<Value>(collection: Record<string, Value>, key: string): Observed<Value>;\nexport function toValue<Value>(\n  collection: Array<Value> | Record<string, Value>,\n  key: number | string\n): Observed<Value> {\n  return new Observed(collection as any, source => source[key]);\n}\n\nexport function toValues<Collection extends any[]>(\n  collection: Collection\n): ObservedValues<Collection>;\nexport function toValues<Collection extends Record<string, any>>(\n  collection: Collection\n): ObservedValues<Collection>;\nexport function toValues<Value>(\n  collection: Value[] | Record<string, Value>\n): ObservedValues<Value[] | Record<string, Value>> {\n  if (Array.isArray(collection)) {\n    return collection.map((_, index) => new Observed(collection, source => source[index]));\n  }\n\n  const values: Record<string, Observed<Value>> = {};\n\n  for (const key in collection) {\n    if (collection.hasOwnProperty(key)) {\n      values[key] = new Observed(collection, source => source[key]);\n    }\n  }\n\n  return values;\n}\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}